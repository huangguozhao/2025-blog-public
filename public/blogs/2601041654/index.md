# Dstat和nmon监控工具

## 一、Dstat综合监控工具

### 1. **工具概述**

- **名称**：Dstat（超级监控工具）
- **性质**：第三方工具，需要安装
- **特点**：整合多维度监控到单一工具
- **开发语言**：Python

### 2. **安装命令**

```bash
yum install -y dstat
```

### 3. **常用命令与参数**

```bash
# 基本综合监控
dstat -tcmnd --disk-util

# 参数说明
-t: time（时间戳）
-c: CPU（CPU监控）
-m: memory（内存监控）
-n: network（网络监控）
-d: disk（磁盘监控）
--disk-util: 磁盘繁忙度
```

### 4. **监控输出解读**

| 监控项         | 字段                         | 含义                              | 对应关系                 |
| -------------- | ---------------------------- | --------------------------------- | ------------------------ |
| **CPU**        | usr, sys, idl, wai, hiq, siq | 用户/系统/空闲/等待/硬中断/软中断 | 同top命令                |
| **内存**       | used, buff, cach, free       | 已用/缓冲/缓存/空闲               | 同free命令               |
| **网络**       | recv, send                   | 接收/发送流量(KB/s)               | recv=rxkB/s, send=txkB/s |
| **磁盘**       | read, writ                   | 读/写流量(KB/s)                   | read=rkB/s, writ=wkB/s   |
| **磁盘繁忙度** | util                         | 磁盘使用率(%)                     | 同iostat %util           |

### 5. **高级用法：后台监控**

```bash
# 后台监控并保存日志
nohup dstat -tcmnd --disk-util > cc.log &

# 参数解释
nohup: 忽略挂起信号
&: 后台运行
> cc.log: 输出重定向到日志文件

# 查看实时日志
tail -f cc.log

# 停止监控
ps -ef | grep dstat  # 查找进程ID
kill -9 <进程ID>      # 结束进程
```

### 6. **优势与局限**

- **优势**：
  - 一站式监控，无需切换多个命令
  - 实时刷新，数据直观
  - 支持数据持久化（日志文件）
- **局限**：
  - 需要额外安装
  - 原生命令仍需掌握（面试基础）

## 二、nmon性能监控与分析工具

### 1. **工具概述**

- **名称**：nmon（Nigel's Monitor）
- **开发商**：IBM
- **用途**：性能监控与报告生成
- **组成**：
  - **监控程序**：Linux命令行工具
  - **分析器**：Excel工具（nmon analyser）

### 2. **获取与配置**

#### (1) **程序获取**

- **来源**：IBM官网（可下载各Linux版本）
- **版本对应**：不同Linux发行版需对应版本
  - 示例：nmon_x86_64_centos7（CentOS 7专用）
- **备用方案**：使用提供的预编译版本

#### (2) **环境配置**

```bash
# 上传nmon程序到Linux服务器
# 重命名简化
mv nmon_x86_64_centos7 nmon

# 添加执行权限
chmod +x nmon

# 验证：变为绿色表示有执行权限
```

### 3. **监控数据采集**

```bash
# 启动监控
./nmon -fT -s 5 -c 100

# 参数说明
-f: 输出到文件（默认：主机名_日期时间.nmon）
-T: 包含Top进程信息
-s: 采样间隔（秒）
-c: 采样次数

# 示例计算
# 监控10分钟（600秒），间隔5秒
# 采样次数 = 600 / 5 = 120次
./nmon -fT -s 5 -c 120
```

### 4. **监控文件生成**

- **文件名格式**：`主机名_年月日_时分.nmon`
  - 示例：`MTX_230326_1530.nmon`
- **文件内容**：文本格式监控数据
- **监控时机**：压测开始 → 监控开始，压测结束 → 监控结束

### 5. **数据分析器使用**

#### (1) **环境要求**

- **必需软件**：Microsoft Excel（不支持WPS）
- **安全提示**：启用宏才能正常使用

#### (2) **分析流程**

1. **下载监控文件**：从Linux服务器下载到Windows
2. **打开nmon analyser**：双击打开Excel工具
3. **导入数据**：选择.nmon文件
4. **生成报告**：自动生成Excel分析报告

#### (3) **报告结构**

```
报告文件结构：
1. 系统概要（SYS_SUMM）- 核心指标趋势图
2. CPU监控（CPU_ALL）- CPU使用率详情
3. 磁盘监控（DISKBUSY）- 磁盘繁忙度
4. 网络监控（NET）- 网络流量
5. 内存监控（MEM）- 内存使用情况
6. 其他详细数据（多标签页）
```

### 6. **报告解读指南**

#### (1) **系统概要（SYS_SUMM）**

- **CPU曲线（蓝色）**：整体CPU使用率（%）
  - 横轴：时间
  - 纵轴：CPU使用率（0-100%）
  - 分析：观察压测期间CPU变化趋势
- **磁盘写曲线（粉色）**：磁盘写入流量（KB/s）
  - 特征：脉冲式波形（缓冲机制导致）
  - 解释：批量写磁盘，非实时写入

#### (2) **CPU详细监控**

- **CPU_ALL**：整体CPU使用率折线图
- **CPU%**：各核心详细数据表格
- **CPU2**：用户/系统/等待/空闲占比柱状图
  - 颜色标识：
    - 蓝色：用户进程（usr）
    - 橙色：系统进程（sys）
    - 其他：等待/空闲等

#### (3) **磁盘监控（DISKBUSY）**

- **关注对象**：sda（主磁盘）
- **指标**：磁盘繁忙度（%）
- **判断标准**：< 90%
- **图表类型**：柱状图/折线图
- **特征**：多数时间为0，偶尔峰值

#### (4) **网络监控（NET）**

- **识别物理网卡**：
  - 物理网卡：eth0、ens33、en开头
  - 虚拟网卡：docker创建（可忽略）
- **关键指标**：
  - read：接收流量（KB/s）
  - write：发送流量（KB/s）
  - total：总流量
- **内网压测特征**：
  - 流量远低于千兆网卡上限（125MB/s）
  - 几乎不会遇到网络瓶颈

#### (5) **内存监控（MEM）**

- **指标**：空闲内存（memory free）
- **单位**：MB
- **图表**：折线图显示空闲内存变化

### 7. **工具对比**

| 对比项       | Dstat             | nmon                       |
| ------------ | ----------------- | -------------------------- |
| **安装**     | yum安装           | 下载二进制文件             |
| **使用**     | 命令行实时监控    | 监控+离线分析              |
| **输出**     | 终端/文本日志     | .nmon文件+Excel报告        |
| **可视化**   | 文本表格          | 专业图表（Excel生成）      |
| **适合场景** | 实时监控/简单分析 | 正式报告/详细分析          |
| **学习成本** | 低                | 中（需掌握报告解读）       |
| **报告质量** | 基础              | 专业（可直接用于客户报告） |

### 8. **实战应用建议**

#### (1) **工具选择策略**

- **日常监控/快速检查**：使用top、free、iostat等原生命令
- **综合实时监控**：使用Dstat
- **正式压测报告**：使用nmon生成专业图表

#### (2) **监控最佳实践**

1. **压测前**：确认监控工具就绪
2. **压测开始**：立即启动监控（nmon或Dstat）
3. **压测期间**：使用Dstat/top实时观察
4. **压测结束**：停止监控，收集数据
5. **报告生成**：使用nmon analyser分析数据

#### (3) **数据关联分析**

- **时间对齐**：确保监控时间与压测时间匹配
- **指标关联**：结合TPS、响应时间分析资源使用
- **瓶颈定位**：资源指标异常 → 性能问题根源