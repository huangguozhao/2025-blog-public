### **性能测试实战：目的、策略与执行详解**

#### **一、性能测试的核心目的**

性能测试通常围绕两个核心目标展开，它们分别关注系统能力的**效率**和**极限**。

| 目的                              | 核心指标              | 停止标准 / “失败”标志                                        |
| :-------------------------------- | :-------------------- | :----------------------------------------------------------- |
| **1. 测试系统的最大处理能力**     | **TPS（每秒事务数）** | 找到 **“性能拐点”**。即当并发用户数增加，但TPS不再显著增长（或开始下降）的临界点。此时系统处理效率达到峰值。 |
| **2. 测试系统的最高并发支持能力** | **并发用户数**        | 系统出现**不可用或性能严重劣化**的迹象。包括：<br>• **系统/应用崩溃、宕机**。<br>• **关键进程异常退出**。<br>• **错误率（如HTTP 5xx）持续、显著上升**。<br>• **平均/百分位响应时间超出可接受范围**（如 > 10秒）。<br>• **应用无响应**（请求超时）。 |

**重要理解**：

*   **目的1** 关注的是 **“系统在最佳状态下能干多少活”**。
*   **目的2** 关注的是 **“系统在崩溃前能承受多少用户”**。
*   **实际工作中**，这两个目标可能单独出现，也可能合并在一个测试任务中。专业团队通常使用 **“压测”** 一词涵盖所有场景，重点在于明确**本次测试的具体目标**，而非纠结“压力测试”、“负载测试”等术语的定义。

#### **二、性能测试的典型场景**

一个完整的性能测试评估通常会遵循以下顺序，由简入繁，由局部到整体：

1.  **单接口基准测试**：
    *   **目的**：评估单个核心接口的性能基线，验证其独立处理能力。
    *   **场景**：使用固定或较低并发，持续运行数分钟，获取稳定的TPS和响应时间数据。

2.  **混合场景负载测试**：
    *   **目的**：模拟真实用户行为，按照**实际业务比例**（如登录:浏览:下单 ≈ 2:7:1）混合调用多个接口。
    *   **场景**：考察系统在复杂、真实的业务流下的综合性能及资源分配情况。

3.  **稳定性/耐力测试**：
    *   **目的**：验证系统在**长时间**（如12/24小时）压力下是否存在内存泄漏、性能衰减等问题。
    *   **场景**：在预估的日常压力（如平均TPS的80%）下持续运行。

#### **三、性能测试的执行策略：寻找拐点**

**核心宗旨**：**“从小并发开始，逐步增压，寻找性能拐点”**。

1. **为何要“逐步增压”？**

   *   **安全性**：避免突发高并发直接压垮系统，导致测试无法进行或数据丢失。
   *   **精确性**：可以更细致地观察系统性能随压力变化的趋势，精准定位拐点。

2. **何为“性能拐点”？**

   * **最佳并发点**：在性能曲线上，TPS随并发数增加而**线性增长**的终点。超过此点，TPS增长**趋于平缓甚至下降**，而响应时间开始**显著增加**。

   * **图示理解**：

     ```
     并发数 ↗ -> TPS ↗ (线性增长期) -> TPS → (性能瓶颈期) -> TPS ↘ (性能衰退期)
     响应时间 → (基本稳定)        -> 响应时间 ↗ (开始劣化) -> 响应时间 ↗↗ (严重劣化)
     ```

   * **拐点意义**：此点对应的并发数是**性价比最高**的并发数，系统以较高的吞吐量和可接受的延迟运行。这是容量规划和性能优化的关键参考。

3. **增压策略的灵活性**：

   *   **初始步长**：通常从较小的并发数开始（如10个用户）。
   *   **动态调整**：根据TPS的增长幅度**动态调整**下一次的并发增量。
       *   **若TPS增幅很大**（如并发+10，TPS+50%）：说明系统远未达瓶颈，**可加大步长**（如+30，+50）。
       *   **若TPS增幅变小**（如并发+10，TPS+<5%）：说明接近拐点，**应减小步长**，精细探测。
   *   **经验判断**：个位数的TPS波动通常可视为误差，应关注**趋势性变化**。当响应时间增幅开始远超TPS增幅时，需格外警惕。

#### **四、实战演示：通过命令行动态控制测试参数**

为了避免频繁修改和上传JMX脚本，可以利用JMeter的**命令行参数传递**功能，实现测试配置的**动态化**。

**操作步骤**：

1. **在JMeter脚本中参数化**：

   *   在线程组的“线程数”和“持续时间”字段中，使用 **`${__P(参数名, 默认值)}`** 函数。
   *   **例如**：
       *   线程数：`${__P(threadNum, 10)}` （默认10个线程）
       *   持续时间：`${__P(duration, 30)}` （默认30秒）

2. **通过命令行传递参数**：

   * 在执行`jmeter`命令时，使用 **`-J参数名=值`** 的格式来覆盖脚本中的默认值。

   * **完整命令示例**：

     ```bash
     jmeter -n -t test.jmx -l result_100.jtl -JthreadNum=100 -Jduration=60
     ```

     *   此命令会以**100个并发线程**运行测试，持续**60秒**，结果保存到`result_100.jtl`。

**优势**：

*   **高效灵活**：无需修改脚本文件，一行命令即可改变核心测试参数。
*   **易于自动化**：便于集成到CI/CD流水线或编写批量测试脚本。
*   **结果隔离**：通过将并发数包含在结果文件名中（如`result_100.jtl`），自然实现了不同压力档次结果的分类存储。

#### **五、测试数据记录与分析模板**

在执行逐步增压测试时，必须系统化地记录每次迭代的数据。

| 序号 | 接口名称 | 并发数 | 持续时间(s) | **TPS** | **平均响应时间(ms)** | 错误率(%) | CPU使用率 | 内存使用率 | 备注         |
| :--- | :------- | :----- | :---------- | :------ | :------------------- | :-------- | :-------- | :--------- | :----------- |
| 1    | 用户列表 | 10     | 30          | 264     | 36                   | 0         | (待监控)  | (待监控)   |              |
| 2    | 用户列表 | 20     | 30          | 504     | 38                   | 0         | ...       | ...        |              |
| 3    | 用户列表 | 30     | 30          | 722     | 40                   | 0         | ...       | ...        |              |
| 4    | 用户列表 | 50     | 40          | 1115    | 42                   | 0         | ...       | ...        |              |
| 5    | 用户列表 | 100    | 30          | 1487    | 65                   | 0         | ...       | ...        | **增长放缓** |
| ...  | ...      | ...    | ...         | ...     | ...                  | ...       | ...       | ...        |              |

**如何分析**：

1.  观察 **TPS 趋势**：随着并发数增加，TPS何时增长变缓、趋于稳定或下降。
2.  观察 **响应时间趋势**：响应时间何时开始非线性地显著增加。
3.  结合 **错误率和资源监控**：判断系统瓶颈是应用层、数据库还是服务器资源（CPU、内存、IO、网络）。

#### **六、总结与后续**

本节课的核心是建立性能测试的**系统性思维**：

1.  **明确目标**：是测效率（TPS拐点）还是测极限（最高并发）？
2.  **设计场景**：单点、混合还是稳定性？
3.  **执行策略**：采用“逐步增压，寻找拐点”的科学方法。
4.  **工具技巧**：熟练使用JMeter命令行参数化，提升测试效率。
5.  **数据记录**：规范记录，为后续分析和报告提供依据。

**下一步**：将继续增加并发，直至找到该接口的**性能拐点**（TPS稳定点），并演示当并发过高时，系统可能出现的**性能衰退现象**（如错误率上升、响应时间激增），从而完整展示从“最佳并发”到“最高并发”的整个探测过程。同时，将引入服务器资源监控，使性能分析更加立体。